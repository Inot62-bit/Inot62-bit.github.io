<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blutdruck ‚Äì G√§steseite</title>

<style>
.table-wrapper {overflow-x:auto;width:100%;-webkit-overflow-scrolling:touch;margin-top:15px;}
table {width:950px;border-collapse:collapse;margin-top:20px;font-family:Arial;font-size:17px;}
th {background-color:#e3eaf3;color:#2a3b55;padding:10px;border:1px solid #c5d1df;}
td {padding:10px;border:1px solid #c5d1df;text-align:center;background-color:#f8fafc;white-space:pre-line;}
tr:nth-child(even) td {background-color:#f0f4f8;}
button {margin-top:10px;padding:10px 18px;background-color:#2a3b55;color:white;border:none;border-radius:5px;font-size:15px;}
.btn-row {display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:15px;}
.bp-chart-container {width:100%;overflow-x:auto;margin:25px auto;}
canvas {width:100%!important;height:auto!important;}
@media print { body{display:none;} }
</style>
</head>
<body>

<div id="guestContent">

    <div style="text-align:center; margin-top:15px; font-family:Arial;">
        <button id="langDE">üá©üá™ Deutsch</button>
        <button id="langRU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
    </div>

    <div id="headerBlock"
         style="text-align:center; margin-top:20px; font-family:Arial; color:#2a3b55; max-width:90%; margin-left:auto; margin-right:auto;">
    </div>

    <div class="bp-chart-container">
        <canvas id="bpChart"></canvas>
    </div>

    <div class="table-wrapper">
        <table id="bpTable">
            <thead id="tableHead"></thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="btn-row" id="buttonRow"></div>

</div>

<!-- ===== Chart.js –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π ===== -->
<script>
<script>
/* ===== Chart.js LITE ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –º–∏–Ω–∏-–≤–µ—Ä—Å–∏—è –¥–ª—è Android WebView ===== */

class SimpleChart {
    constructor(ctx, config) {
        this.ctx = ctx;
        this.type = config.type || "line";
        this.data = config.data || { labels: [], datasets: [] };
        this.options = config.options || {};
        this.draw();
    }

    update() {
        this.draw();
    }

    draw() {
        const ctx = this.ctx;
        const w = ctx.canvas.width;
        const h = ctx.canvas.height;

        ctx.clearRect(0, 0, w, h);

        // —Ñ–æ–Ω
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, w, h);

        if (!this.data.labels.length) return;

        let maxY = 0;
        let minY = 9999;

        for (let ds of this.data.datasets) {
            for (let v of ds.data) {
                if (v > maxY) maxY = v;
                if (v < minY) minY = v;
            }
        }

        if (minY === maxY) maxY += 1;

        let leftPadding = 40;
        let bottomPadding = 30;

        let chartW = w - leftPadding - 10;
        let chartH = h - bottomPadding - 10;

        // –æ—Å–∏
        ctx.strokeStyle = "#444";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(leftPadding, 10);
        ctx.lineTo(leftPadding, chartH + 10);
        ctx.lineTo(chartW + leftPadding, chartH + 10);
        ctx.stroke();

        const count = this.data.labels.length;
        const stepX = chartW / Math.max(1, count - 1);

        function getY(v) {
            return (
                chartH +
                10 -
                ((v - minY) / (maxY - minY)) * chartH
            );
        }

        // –ª–∏–Ω–∏–∏
        for (let ds of this.data.datasets) {
            ctx.strokeStyle = ds.borderColor || "#000";
            ctx.lineWidth = 2;
            ctx.beginPath();

            ds.data.forEach((v, i) => {
                let x = leftPadding + i * stepX;
                let y = getY(v);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // —Ç–æ—á–∫–∏
            ctx.fillStyle = ds.borderColor || "#000";
            ds.data.forEach((v, i) => {
                let x = leftPadding + i * stepX;
                let y = getY(v);
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
    }
}

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Chart
window.Chart = SimpleChart;

</script>
<script>
/* ==== –¢–í–û–ô –û–°–ù–û–í–ù–û–ô JS-–ö–û–î, –ù–ò–ñ–ï –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ==== */
/* (—è –Ω–µ –º–µ–Ω—è–ª —Ç–≤–æ–π –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–¥ ‚Äî —Ç–æ–ª—å–∫–æ Chart) */

/* --- –¢–µ–∫—Å—Ç—ã —è–∑—ã–∫–æ–≤ --- */
const LANG = {
    de:{headerTitle:"",explain:"Jeder Gast kann hier sein eigenes Blutdrucktagebuch f√ºhren.\nDie Daten werden NUR lokal gespeichert.",
    tableHead:`<tr><th>Datum</th><th>Uhrzeit</th><th>Systolisch</th><th>Diastolisch</th><th>Puls</th><th>Anmerkungen</th></tr>`,
    buttons:`<button onclick="setGuestFirstName()">Vorname eingeben</button>
<button onclick="setGuestLastName()">Nachname eingeben</button>
<button onclick="setGuestBirthdate()">Geburtsdatum eingeben</button>
<button onclick="addEntry()">Eintrag hinzuf√ºgen</button>
<button onclick="deleteLast()">Letzten Eintrag l√∂schen</button>
<button onclick="clearToday()">Heutige l√∂schen</button>
<button onclick="clearAll()">Alles l√∂schen</button>
<button onclick="exportCSV()">CSV exportieren</button>`,
    prompts:{sys:"Systolischen Wert:",dia:"Diastolischen Wert:",pulse:"Puls:",
             note:"Notiz:",deleteConfirm:"Alles l√∂schen?",deleteError:"Keine Eintr√§ge.",
             todayEmpty:"Heute keine Eintr√§ge.",firstName:"Vorname:",
             lastName:"Nachname:",birthdate:"Geburtsdatum:"}},

    ru:{headerTitle:"",explain:"–ó–¥–µ—Å—å –∫–∞–∂–¥—ã–π –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –¥–∞–≤–ª–µ–Ω–∏—è.\n–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.",
    tableHead:`<tr><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</th><th>–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</th><th>–ü—É–ª—å—Å</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th></tr>`,
    buttons:`<button onclick="setGuestFirstName()">–í–≤–µ—Å—Ç–∏ –∏–º—è</button>
<button onclick="setGuestLastName()">–í–≤–µ—Å—Ç–∏ —Ñ–∞–º–∏–ª–∏—é</button>
<button onclick="setGuestBirthdate()">–í–≤–µ—Å—Ç–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è</button>
<button onclick="addEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
<button onclick="deleteLast()">–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é</button>
<button onclick="clearToday()">–£–¥–∞–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ</button>
<button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
<button onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>`,
    prompts:{sys:"–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ:",dia:"–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ:",pulse:"–ü—É–ª—å—Å:",
             note:"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:",deleteConfirm:"–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?",
             deleteError:"–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.",todayEmpty:"–ù–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö.",
             firstName:"–ò–º—è:",lastName:"–§–∞–º–∏–ª–∏—è:",birthdate:"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:"}}
};

let currentLang="de";

function getKey(k){ return k+"_"+currentLang }

/* ==== –Ø–∑—ã–∫–∏ ==== */
function applyLanguage(){
    const L=LANG[currentLang];

    const first=localStorage.getItem(getKey("fname"))||"";
    const last =localStorage.getItem(getKey("lname"))||"";
    const dob  =localStorage.getItem(getKey("dob"))||"";
    const full=(first+" "+last).trim();

    document.getElementById("headerBlock").innerHTML=
`<h1 style="margin:0;font-size:26px;font-weight:bold;">
${full? (currentLang==="de"?"Blutdrucktagebuch ‚Äì ":"–î–Ω–µ–≤–Ω–∏–∫ ‚Äì ")+full :
        (currentLang==="de"?"Blutdrucktagebuch":"–î–Ω–µ–≤–Ω–∏–∫ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è")}
</h1>
${full?`<div style="font-size:15px;">${full}</div>`:""}
${dob?`<div style="font-size:13px;">${currentLang==="de"?"Geboren am: ":"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: "} ${dob}</div>`:""}
<div style="font-size:13px;white-space:pre-line;color:#56657c;margin-top:6px;">${L.explain}</div>`;

    document.getElementById("tableHead").innerHTML=L.tableHead;
    document.getElementById("buttonRow").innerHTML=L.buttons;

    loadFromLocal();
    updateChart();
}

/* ==== –ò–º—è ==== */
function setGuestFirstName(){
    let v=prompt(LANG[currentLang].prompts.firstName);
    if(v){ localStorage.setItem(getKey("fname"),v); applyLanguage(); }
}
function setGuestLastName(){
    let v=prompt(LANG[currentLang].prompts.lastName);
    if(v){ localStorage.setItem(getKey("lname"),v); applyLanguage(); }
}
function setGuestBirthdate(){
    let v=prompt(LANG[currentLang].prompts.birthdate);
    if(v){ localStorage.setItem(getKey("dob"),v); applyLanguage(); }
}

/* ==== –¢–∞–±–ª–∏—Ü–∞ ==== */
function addEntry(){
    const P=LANG[currentLang].prompts;
    let s=prompt(P.sys); if(!s) return;
    let d=prompt(P.dia); if(!d) return;
    let p=prompt(P.pulse); if(!p) return;
    let n=prompt(P.note)||"";

    let now=new Date();
    let date=now.toLocaleDateString(currentLang==="de"?"de-DE":"ru-RU");
    let time=now.toLocaleTimeString(currentLang==="de"?"de-DE":"ru-RU",{hour:"2-digit",minute:"2-digit"});

    let tbody=document.querySelector("#bpTable tbody");
    let r=tbody.insertRow();

    r.insertCell().innerText=date;
    r.insertCell().innerText=time;
    r.insertCell().innerText=s;
    r.insertCell().innerText=d;
    r.insertCell().innerText=p;
    r.insertCell().innerText=n;

    saveToLocal();
    updateChart();
}

function deleteLast(){
    let rows=document.querySelector("#bpTable tbody").rows;
    if(rows.length===0){ alert(LANG[currentLang].prompts.deleteError); return; }
    document.querySelector("#bpTable tbody").deleteRow(rows.length-1);
    saveToLocal();
    updateChart();
}

function clearToday(){
    const P=LANG[currentLang].prompts;
    let today=new Date().toLocaleDateString(currentLang==="de"?"de-DE":"ru-RU");
    let tbody=document.querySelector("#bpTable tbody");
    let rows=Array.from(tbody.rows);
    let removed=false;

    rows.forEach(r=>{
        if(r.cells[0].innerText===today){ tbody.removeChild(r); removed=true; }
    });

    if(!removed) alert(P.todayEmpty);
    saveToLocal();
    updateChart();
}

function clearAll(){
    if(!confirm(LANG[currentLang].prompts.deleteConfirm)) return;
    document.querySelector("#bpTable tbody").innerHTML="";
    localStorage.removeItem(getKey("data"));
    updateChart();
}

/* ==== LocalStorage ==== */
function saveToLocal(){
    let rows=document.querySelector("#bpTable tbody").rows;
    let arr=[];
    for(let r of rows){
        arr.push([
            r.cells[0].innerText,
            r.cells[1].innerText,
            r.cells[2].innerText,
            r.cells[3].innerText,
            r.cells[4].innerText,
            r.cells[5].innerText
        ]);
    }
    localStorage.setItem(getKey("data"),JSON.stringify(arr));
}

function loadFromLocal(){
    let saved=localStorage.getItem(getKey("data"));
    let tbody=document.querySelector("#bpTable tbody");
    tbody.innerHTML="";
    if(!saved) return;
    JSON.parse(saved).forEach(a=>{
        let r=tbody.insertRow();
        a.forEach(v=>r.insertCell().innerText=v);
    });
}

/* ==== CSV ==== */
function exportCSV(){
    let rows=document.querySelectorAll("#bpTable tr");
    let csv=[];
    rows.forEach(row=>{
        let cols=row.querySelectorAll("th,td");
        let vals=[];
        cols.forEach(c=>vals.push(c.innerText));
        csv.push(vals.join(","));
    });
    let blob=new Blob([csv.join("\n")],{type:"text/csv"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.href=url;
    a.download=currentLang==="de"?"blutdruck_de.csv":"blutdruck_ru.csv";
    a.click();
}

/* ==== –ì—Ä–∞—Ñ–∏–∫ ==== */
let ctx=document.getElementById("bpChart").getContext("2d");

let bpChart=new Chart(ctx,{
    type:"line",
    data:{
        labels:[],
        datasets:[
            {label:"SYS",data:[],borderColor:"#ff4136"},
            {label:"DIA",data:[],borderColor:"#007bff"},
            {label:"PUL",data:[],borderColor:"#ffdc00"}
        ]
    },
    options:{}
});

function updateChart(){
    let rows=document.querySelector("#bpTable tbody").rows;

    let labels=[],sys=[],dia=[],pul=[];
    for(let r of rows){
        labels.push(r.cells[0].innerText+" "+r.cells[1].innerText);
        sys.push(Number(r.cells[2].innerText));
        dia.push(Number(r.cells[3].innerText));
        pul.push(Number(r.cells[4].innerText));
    }

    bpChart.data.labels=labels;
    bpChart.data.datasets[0].data=sys;
    bpChart.data.datasets[1].data=dia;
    bpChart.data.datasets[2].data=pul;

    bpChart.update();
}

/* ==== –°—Ç–∞—Ä—Ç ==== */
applyLanguage();
document.getElementById("langDE").onclick=()=>{ currentLang="de"; applyLanguage(); };
document.getElementById("langRU").onclick=()=>{ currentLang="ru"; applyLanguage(); };

</script>

</body>
</html>
