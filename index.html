<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blutdruck ‚Äì G√§steseite</title>

<style>
/* ===== –°–¢–ò–õ–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∏–∑–∞–π–Ω–∞) ===== */
.table-wrapper {overflow-x:auto;width:100%;-webkit-overflow-scrolling:touch;margin-top:15px;}
table {width:950px;border-collapse:collapse;margin-top:20px;font-family:Arial;font-size:17px;}
th {background-color:#e3eaf3;color:#2a3b55;padding:10px;border:1px solid #c5d1df;}
td {padding:10px;border:1px solid #c5d1df;text-align:center;background-color:#f8fafc;white-space:pre-line;}
tr:nth-child(even) td {background-color:#f0f4f8;}
button {margin-top:10px;padding:10px 18px;background-color:#2a3b55;color:white;border:none;
        border-radius:5px;font-size:15px;}
button:hover {background-color:#1e2c40;}
.btn-row {display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:15px;}
.bp-chart-container {width:100%;overflow-x:auto;margin:25px auto;}
canvas {width:100%!important;height:auto!important;}
/* ===== PRINT –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è WebView ===== */
@media print { body{display:none;} }
</style>
</head>

<body>

<div id="guestContent">

    <!-- –Ø–∑—ã–∫ -->
    <div style="text-align:center; margin-top:15px; font-family:Arial;">
        <button id="langDE">üá©üá™ Deutsch</button>
        <button id="langRU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div id="headerBlock"
         style="text-align:center; margin-top:20px; font-family:Arial; color:#2a3b55; max-width:90%; margin-left:auto; margin-right:auto;">
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="bp-chart-container">
        <canvas id="bpChart"></canvas>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="table-wrapper">
        <table id="bpTable">
            <thead id="tableHead"></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="btn-row" id="buttonRow"></div>

</div>

<!-- ====== Chart.js –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è WebView) ====== -->
<script src="file:///android_asset/chart.min.js"></script>

<script>
/* ===================================================================
       –ü–ï–†–ï–ü–ò–°–ê–ù–ù–û –î–õ–Ø WEBVIEW ‚Äî –ù–ò–ß–ï–ì–û –í–ù–ï–®–ù–ï–ì–û –ù–ï –ú–ï–ù–Ø–ï–¢
=================================================================== */

function modalPrompt(text, callback) {
    let v = prompt(text);
    callback(v);
}

/* ===== –¢–µ–∫—Å—Ç—ã ===== */
const LANG = {
    de:{headerTitle:"",explain:"Jeder Gast kann hier sein eigenes Blutdrucktagebuch f√ºhren.\nDie Daten werden NUR lokal gespeichert.",
    tableHead:`<tr><th>Datum</th><th>Uhrzeit</th><th>Systolisch</th><th>Diastolisch</th><th>Puls</th><th>Anmerkungen</th></tr>`,
    buttons:`<button onclick="setGuestFirstName()">Vorname eingeben</button>
             <button onclick="setGuestLastName()">Nachname eingeben</button>
             <button onclick="setGuestBirthdate()">Geburtsdatum eingeben</button>
             <button onclick="addEntry()">Eintrag hinzuf√ºgen</button>
             <button onclick="deleteLast()">Letzten Eintrag l√∂schen</button>
             <button onclick="clearToday()">Heutige l√∂schen</button>
             <button onclick="clearAll()">Alles l√∂schen</button>
             <button onclick="exportCSV()">CSV exportieren</button>`,
    prompts:{sys:"Systolischen Wert:",dia:"Diastolischen Wert:",pulse:"Puls:",note:"Notiz:",
             deleteConfirm:"Alles l√∂schen?",deleteError:"Keine Eintr√§ge.",
             todayEmpty:"Heute keine Eintr√§ge.",
             firstName:"Vorname:",lastName:"Nachname:",birthdate:"Geburtsdatum:"}},
    
    ru:{headerTitle:"",explain:"–ó–¥–µ—Å—å –∫–∞–∂–¥—ã–π –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –¥–∞–≤–ª–µ–Ω–∏—è.\n–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.",
    tableHead:`<tr><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</th><th>–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</th><th>–ü—É–ª—å—Å</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th></tr>`,
    buttons:`<button onclick="setGuestFirstName()">–í–≤–µ—Å—Ç–∏ –∏–º—è</button>
             <button onclick="setGuestLastName()">–í–≤–µ—Å—Ç–∏ —Ñ–∞–º–∏–ª–∏—é</button>
             <button onclick="setGuestBirthdate()">–í–≤–µ—Å—Ç–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è</button>
             <button onclick="addEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
             <button onclick="deleteLast()">–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é</button>
             <button onclick="clearToday()">–£–¥–∞–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ</button>
             <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
             <button onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>`,
    prompts:{sys:"–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ:",dia:"–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ:",pulse:"–ü—É–ª—å—Å:",
             note:"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:",deleteConfirm:"–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?",
             deleteError:"–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.",todayEmpty:"–ù–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö.",
             firstName:"–ò–º—è:",lastName:"–§–∞–º–∏–ª–∏—è:",birthdate:"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:"}}
};

let currentLang="de";

function getKey(base){
    return `${base}_${currentLang}`;
}

/* ===== –ó–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–∞ ===== */
function applyLanguage(){
    const L=LANG[currentLang];
    let first=localStorage.getItem(getKey("fname"))||"";
    let last =localStorage.getItem(getKey("lname"))||"";
    let dob  =localStorage.getItem(getKey("dob"))||"";
    let full =`${first} ${last}`.trim();

    document.getElementById("headerBlock").innerHTML=
        `<h1 style="margin:0;font-size:26px;font-weight:bold;">
            ${full ? (currentLang==="de"?"Blutdrucktagebuch ‚Äì ":"–î–Ω–µ–≤–Ω–∏–∫ ‚Äì ")+full :
                     (currentLang==="de"?"Blutdrucktagebuch":"–î–Ω–µ–≤–Ω–∏–∫ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è")}
         </h1>
         ${full?`<div style="font-size:15px;">${full}</div>`:""}
         ${dob?`<div style="font-size:13px;margin-top:2px;">${currentLang==="de"?"Geboren am: ":"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: "} ${dob}</div>`:""}
         <div style="font-size:13px;margin-top:6px;color:#56657c;white-space:pre-line;">${L.explain}</div>`;

    document.getElementById("tableHead").innerHTML=L.tableHead;
    document.getElementById("buttonRow").innerHTML=L.buttons;

    loadFromLocal();
    updateChart();
}

/* ===== –ò–º—è / –§–∞–º–∏–ª–∏—è / –î–∞—Ç–∞ ===== */
function setGuestFirstName(){
    modalPrompt(LANG[currentLang].prompts.firstName,v=>{
        if(v){localStorage.setItem(getKey("fname"),v);applyLanguage();}
    });
}

function setGuestLastName(){
    modalPrompt(LANG[currentLang].prompts.lastName,v=>{
        if(v){localStorage.setItem(getKey("lname"),v);applyLanguage();}
    });
}

function setGuestBirthdate(){
    modalPrompt(LANG[currentLang].prompts.birthdate,v=>{
        if(v){localStorage.setItem(getKey("dob"),v);applyLanguage();}
    });
}

/* ===== –¢–∞–±–ª–∏—Ü–∞ ===== */
function addEntry(){
    const P=LANG[currentLang].prompts;
    modalPrompt(P.sys, sys=>{
        if(!sys) return;
        modalPrompt(P.dia, dia=>{
            if(!dia) return;
            modalPrompt(P.pulse, pul=>{
                if(!pul) return;
                modalPrompt(P.note, note=>{
                    let now=new Date();
                    let d=now.toLocaleDateString(currentLang==="de"?"de-DE":"ru-RU");
                    let t=now.toLocaleTimeString(currentLang==="de"?"de-DE":"ru-RU",{hour:"2-digit",minute:"2-digit"});

                    let tbody=document.querySelector("#bpTable tbody");
                    let r=tbody.insertRow();
                    r.insertCell(0).innerText=d;
                    r.insertCell(1).innerText=t;
                    r.insertCell(2).innerText=sys;
                    r.insertCell(3).innerText=dia;
                    r.insertCell(4).innerText=pul;
                    r.insertCell(5).innerText=note||"";

                    saveToLocal();
                    updateChart();
                });
            });
        });
    });
}

function deleteLast(){
    let rows=document.querySelector("#bpTable tbody").rows;
    if(rows.length===0){ alert(LANG[currentLang].prompts.deleteError); return; }
    document.querySelector("#bpTable tbody").deleteRow(rows.length-1);
    saveToLocal();
    updateChart();
}

function clearToday(){
    const P=LANG[currentLang].prompts;
    let today=new Date().toLocaleDateString(currentLang==="de"?"de-DE":"ru-RU");
    let tbody=document.querySelector("#bpTable tbody");
    let rows=Array.from(tbody.rows);
    let removed=false;

    rows.forEach(r=>{
        if(r.cells[0].innerText===today){tbody.removeChild(r);removed=true;}
    });

    if(!removed){alert(P.todayEmpty);return;}
    saveToLocal();
    updateChart();
}

function clearAll(){
    if(!confirm(LANG[currentLang].prompts.deleteConfirm)) return;
    document.querySelector("#bpTable tbody").innerHTML="";
    localStorage.removeItem(getKey("data"));
    updateChart();
}

/* ===== LocalStorage ===== */
function saveToLocal(){
    let rows=document.querySelector("#bpTable tbody").rows;
    let out=[];
    for(let r of rows){
        out.push([
            r.cells[0].innerText,
            r.cells[1].innerText,
            r.cells[2].innerText,
            r.cells[3].innerText,
            r.cells[4].innerText,
            r.cells[5].innerText
        ]);
    }
    localStorage.setItem(getKey("data"),JSON.stringify(out));
}

function loadFromLocal(){
    let saved=localStorage.getItem(getKey("data"));
    let tbody=document.querySelector("#bpTable tbody");
    tbody.innerHTML="";
    if(!saved) return;
    JSON.parse(saved).forEach(row=>{
        let r=tbody.insertRow();
        row.forEach(v=>r.insertCell().innerText=v);
    });
}

/* ===== CSV ===== */
function exportCSV(){
    let rows=document.querySelectorAll("#bpTable tr");
    let csv=[];
    for(let row of rows){
        let cols=row.querySelectorAll("th,td");
        let d=[];
        cols.forEach(c=>d.push(c.innerText));
        csv.push(d.join(","));
    }
    let blob=new Blob([csv.join("\n")],{type:"text/csv"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.href=url;
    a.download=currentLang==="de"?"blutdruck_de.csv":"blutdruck_ru.csv";
    a.click();
}

/* ===== Chart.js ===== */
const bpBackground={id:"bpBackground",beforeDraw(chart){
    const{ctx,chartArea:{left,right},scales:{y}}=chart;
    ctx.fillStyle='rgba(120,200,120,0.15)'; ctx.fillRect(left,y.getPixelForValue(80),right-left,y.getPixelForValue(0)-y.getPixelForValue(80));
    ctx.fillStyle='rgba(255,215,0,0.18)';  ctx.fillRect(left,y.getPixelForValue(90),right-left,y.getPixelForValue(80)-y.getPixelForValue(90));
    ctx.fillStyle='rgba(255,99,132,0.18)'; ctx.fillRect(left,y.getPixelForValue(200),right-left,y.getPixelForValue(90)-y.getPixelForValue(200));
}};

let ctx2=document.getElementById("bpChart").getContext("2d");
let bpChart=new Chart(ctx2,{
    type:"line",
    plugins:[bpBackground],
    data:{labels:[],datasets:[
        {label:"SYS",data:[],borderColor:"#ff4136",backgroundColor:"#ff413640",pointRadius:3,tension:0.3},
        {label:"DIA",data:[],borderColor:"#007bff",backgroundColor:"#007bff40",pointRadius:3,tension:0.3},
        {label:"PUL",data:[],borderColor:"#ffdc00",backgroundColor:"#ffdc0040",pointRadius:3,tension:0.3}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
        scales:{y:{suggestedMin:50,suggestedMax:200}}}
});

function updateChart(){
    let rows=document.querySelector("#bpTable tbody").rows;
    let labels=[],sys=[],dia=[],pul=[];
    for(let r of rows){
        labels.push(r.cells[0].innerText+" "+r.cells[1].innerText);
        sys.push(Number(r.cells[2].innerText));
        dia.push(Number(r.cells[3].innerText));
        pul.push(Number(r.cells[4].innerText));
    }
    bpChart.data.labels=labels;
    bpChart.data.datasets[0].data=sys;
    bpChart.data.datasets[1].data=dia;
    bpChart.data.datasets[2].data=pul;

    bpChart.data.datasets[0].label=currentLang==="de"?"Systolisch":"–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ";
    bpChart.data.datasets[1].label=currentLang==="de"?"Diastolisch":"–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ";
    bpChart.data.datasets[2].label=currentLang==="de"?"Puls":"–ü—É–ª—å—Å";

    bpChart.update();
}

/* ===== START ===== */
applyLanguage();

document.getElementById("langDE").onclick=()=>{currentLang="de";applyLanguage();}
document.getElementById("langRU").onclick=()=>{currentLang="ru";applyLanguage();}

</script>

</body>
</html>
